    <!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<meta name="description" content="The official blog of Minko Gechev">
		<meta name="generator" content="Hugo 0.22-DEV" />
		<title>Remote Desktop Client with AngularJS and Yeoman &middot; Minko Gechev&#39;s blog</title>
		<link rel="shortcut icon" href="http://blog.mgechev.com/images/favicon.ico">
		<link rel="stylesheet" href="http://blog.mgechev.com/css/style.css">
		<link rel="stylesheet" href="http://blog.mgechev.com/css/highlight.css">
		<link rel="stylesheet" href="http://blog.mgechev.com/css/firacode/fira.css">
		

		
		<link rel="stylesheet" href="http://blog.mgechev.com/css/font-awesome.min.css">
		

		
		<link href="http://blog.mgechev.com/index.xml" rel="alternate" type="application/rss+xml" title="Minko Gechev&#39;s blog" />
		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='http://blog.mgechev.com/'> <span class="arrow">←</span>Home</a>
	
	<a href='http://blog.mgechev.com/about'>About</a>
	<a href='http://blog.mgechev.com/talks'>Talks</a>
	<a href='http://blog.mgechev.com/post'>Archive</a>

	

	
	<a class="cta" href="http://blog.mgechev.com/index.xml">Subscribe</a>
	
</nav>


        <section id="wrapper">
            <article class="post">
                <header>
                    <h1>
                        Remote Desktop Client with AngularJS and Yeoman
                    </h1>
                    <h2 class="headline">
                    <a href="https://github.com/mgechev/blog.mgechev.com/tree/gh-pages/_posts/post/2014-02-08-remote-desktop-vnc-client-with-angularjs-and-yeoman.md">
                        <i class="fa fa-pencil-square-o"></i> Edit
                    </a>
                    · Feb 8, 2014 00:00
                    · 3973 words
                    · 19 minutes read
                      <span class="tags">
                      
                      
                          
                              <a href="http://blog.mgechev.com/tags/AngularJS">AngularJS</a>
                          
                              <a href="http://blog.mgechev.com/tags/canvas">canvas</a>
                          
                              <a href="http://blog.mgechev.com/tags/HTML5">HTML5</a>
                          
                              <a href="http://blog.mgechev.com/tags/JavaScript">JavaScript</a>
                          
                              <a href="http://blog.mgechev.com/tags/Node.js">Node.js</a>
                          
                              <a href="http://blog.mgechev.com/tags/vnc">vnc</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    

<p>In this blog post I&#8217;m going to show you how to build a VNC client using <a href="http://angularjs.org/">AngularJS</a> and <a href="http://yeoman.io/">Yeoman</a>. The source code used in the post is available at my <a href="https://github.com/mgechev/angular-vnc">GitHub</a>. Click <a href="#vnc-demo-video">here</a> to see the final result.</p>

<p><a href="/images/legacy/uploads2014/02/yeoman-vnc-angular.png"><img src="/images/legacy/uploads2014/02/yeoman-vnc-angular.png" alt="yeoman-vnc-angular" width="600" height="200" class="aligncenter size-full wp-image-647" /></a></p>

<p>It seems I have affinity to the remote desktop protocols, because this is my third project at <a href="https://github.com/mgechev">GitHub</a>, which implements one (<a href="https://github.com/mgechev/js-vnc-demo-project">VNC client on 200 lines of JavaScript</a>, <a href="https://github.com/mgechev/devtools-vnc">VNC client for Chrome DevTools</a> and <a href="https://github.com/mgechev/angular-vnc">VNC client with AngularJS</a>).</p>

<p>Anyway, lets begin with the tutorial.</p>

<h2 id="architecture">Architecture</h2>

<p>First, lets take a look at our architecture:</p>

<p><a href="/images/legacy/uploads2014/02/angular-vnc.png"><img class="aligncenter size-full wp-image-629" alt="angular-vnc" src="/images/legacy/uploads2014/02/angular-vnc.png" width="572" height="232" /></a></p>

<p>We should have a VNC server on the machine we want to control. This machine provides interface accessible through the <a href="https://en.wikipedia.org/wiki/RFB_protocol">RFB protocol</a>. The proxy in the middle has RFB client, which knows how to talk to the RFB server. The proxy also provides HTTP server, which is responsible for serving static files to the client and also allows communication through <a href="http://socket.io/">socket.io</a>. The last component in our diagram is the &#8220;AngularJS VNC client&#8221;, which consists few HTML and JavaScript files provided to the browser by the proxy. This is what actually the user of our VNC client sees. He or she use the form provided in the &#8220;AngularJS VNC client&#8221; in order to enter connection details and connect to the machine he or she wants to control</p>

<h2 id="proxy">Proxy</h2>

<p><em>If you&#8217;re not interested in the Node.js stuff, you can <a href="#angular-vnc">skip it</a> and just copy and paste the code for the proxy from <a href="https://github.com/mgechev/angular-vnc/tree/master/proxy">GitHub</a>.</em></p>

<p>We can now continue with our proxy server. Create a directory called <code>angular-vnc</code>. Inside it create another one called <code>proxy</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>mkdir angular-vnc
<span class="nb">cd</span> angular-vnc
mkdir proxy
<span class="nb">cd</span> proxy
<span class="c1"># Initialize the node.js application, creates package.json</span>
npm init
</code></pre></div>


<p>Now lets install all the dependencies required for our proxy server:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="c1"># Required for the communication with the AngularJS client</span>
npm install socketio --save
<span class="c1"># Required for the communication with the VNC server</span>
npm install rfb --save
<span class="c1"># It provides the static files of the AngularJS client</span>
npm install express --save
<span class="c1"># We use it to create HTTP server</span>
npm install http --save
<span class="c1"># We use it to process the received frames</span>
npm i git+https://github.com/pkrumins/node-png --save
</code></pre></div>


<p>All dependencies are installed, now your <code>package.json</code> should look something like this:</p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;js-vnc&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;repository&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;git&quot;</span><span class="p">,</span>
    <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;socket.io&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.9.16&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rfb&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.2.3&quot;</span><span class="p">,</span>
    <span class="nt">&quot;express&quot;</span><span class="p">:</span> <span class="s2">&quot;~3.4.8&quot;</span><span class="p">,</span>
    <span class="nt">&quot;http&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;png&quot;</span><span class="p">:</span> <span class="s2">&quot;git+https://github.com/pkrumins/node-png&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>We will put our proxy in folder called <code>lib</code>, located inside <code>angular-vnc/proxy</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>mkdir lib
touch lib/server.js
touch index.js
</code></pre></div>


<p>Note that we created one more file in the root directory of our proxy, we will use it to start the proxy server.</p>

<p>Add the following content inside <code>index.js</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/server&#39;</span><span class="p">);</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
</code></pre></div>


<p>Using CommonJS we require our server, located inside the <code>lib</code> folder and call its <code>run</code> method. In order to make this code work, we should define <code>run</code> method in <code>./lib/server.js</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">),</span>
    <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">),</span>
    <span class="nx">Config</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">HTTP_PORT</span><span class="o">:</span> <span class="mi">8090</span>
    <span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">(),</span>
      <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>

  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../../client/app&#39;</span><span class="p">));</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">Config</span><span class="p">.</span><span class="nx">HTTP_PORT</span><span class="p">);</span>
  <span class="nx">io</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="p">{</span> <span class="nx">log</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>
  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Client connected&#39;</span><span class="p">);</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">createRfbConnection</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evnt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">sendPointer</span><span class="p">(</span><span class="nx">evnt</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">evnt</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">evnt</span><span class="p">.</span><span class="nx">button</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;keyboard&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evnt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">sendKey</span><span class="p">(</span><span class="nx">evnt</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span> <span class="nx">evnt</span><span class="p">.</span><span class="nx">isDown</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Keyboard input&#39;</span><span class="p">)</span>
      <span class="p">});</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">disconnectClient</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Client disconnected&#39;</span><span class="p">)</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre></div>


<p>In the snippet above we create new Express application, with static directory <code>/../../client/app</code> and also start HTTP server, listening on port <code>8090</code>.<br />
As next step we wrap the HTTP server with socket.io, add event handler for incoming socket.io connections and initialize variable called <code>clients</code>. In the connection handler we add one more event handler, which is invoked when the AngularJS application sends <code>init</code> message. When <code>init</code> message is received, we add three more handlers, which are responsible for handling the incoming mouse, keyboard and disconnect events.</p>

<p>Lets take a quick look at <code>createRfbConnection</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">createRfbConnection</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">RFB</span><span class="p">({</span>
      <span class="nx">host</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
      <span class="nx">port</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span>
      <span class="nx">securityType</span><span class="o">:</span> <span class="s1">&#39;vnc&#39;</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">addEventHandlers</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>With the received by the client configuration we initialize new RFB connection and add some event handlers. Note that you should require <code>RFB</code> in <code>server.js</code>, in order to make the script work:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">RFB</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;rfb&#39;</span><span class="p">);</span>
</code></pre></div>


<p><code>addEventHandlers</code> adds event handlers, which should handle RFB events, like errors and new incoming frames.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">addEventHandlers</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">initialized</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">screenWidth</span><span class="p">,</span> <span class="nx">screenHeight</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">handleConnection</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">screenWidth</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>
    <span class="nx">screenHeight</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;RFB connection established&#39;</span><span class="p">);</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">width</span><span class="o">:</span> <span class="nx">width</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="nx">height</span>
    <span class="p">});</span>
    <span class="nx">clients</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">socket</span><span class="o">:</span> <span class="nx">socket</span><span class="p">,</span>
      <span class="nx">rfb</span><span class="o">:</span> <span class="nx">r</span><span class="p">,</span>
      <span class="nx">interval</span><span class="o">:</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">requestRedraw</span><span class="p">();</span>
      <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">});</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">requestRedraw</span><span class="p">();</span>
    <span class="nx">initialized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">r</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error while talking with the remote RFB server&#39;</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">r</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">!</span><span class="nx">initialized</span> <span class="o">&amp;&amp;</span> <span class="nx">handleConnection</span><span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">x</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
      <span class="nx">y</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
      <span class="nx">width</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
      <span class="nx">image</span><span class="o">:</span> <span class="nx">encodeFrame</span><span class="p">(</span><span class="nx">rect</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">)</span>
    <span class="p">});</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">requestUpdate</span><span class="p">({</span>
      <span class="nx">x</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">y</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">subscribe</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">width</span><span class="o">:</span> <span class="nx">screenWidth</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="nx">screenHeight</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">r</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>


<p>Lets take a look at the handler of the <code>raw</code> event. It takes very important role in the initialization of the connection. When we receive a <code>raw</code> event for first time the value of <code>initialized</code> is <code>false</code>, because of the way boolean expressions are being evaluated (see <a href="https://en.wikipedia.org/wiki/Lazy_evaluation">Lazy evaluation</a>), <code>!initialized</code> is evaluated to <code>true</code>, which leads to the call of <code>handleConnection</code>. <code>handleConnection</code> is responsible for notifying the AngularJS client that now we are connected to the VNC server. It also adds the client to the <code>clients</code> collection and changes the value of <code>initialized</code> to <code>true</code>, so when next time we receive new frame this won&#8217;t lead to call of <code>handleConnection</code>.</p>

<p>In other words, <code>!initialized &amp;&amp; handleConnection(rect.width, rect.height);</code> is short version of:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initialized</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">handleConnection</span><span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<p>The next method of our proxy, we are going to look at is <code>encodeFrame</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">encodeFrame</span><span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rgb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">),</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">fb</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rgb</span><span class="p">[</span><span class="nx">offset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">fb</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
    <span class="nx">rgb</span><span class="p">[</span><span class="nx">offset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">fb</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="nx">rgb</span><span class="p">[</span><span class="nx">offset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">fb</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Png</span><span class="p">(</span><span class="nx">rgb</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="s1">&#39;rgb&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">image</span><span class="p">.</span><span class="nx">encodeSync</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>


<p>Don&#8217;t forget to require <code>node-png</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">Png</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../node_modules/png/build/Release/png&#39;</span><span class="p">).</span><span class="nx">Png</span><span class="p">;</span>
</code></pre></div>


<p>All that <code>encodeFrame</code> does is reordering the received pixels and converting them to PNG. The handler of the <code>raw</code> event converts the binary result, received by <code>encodeFrame</code> to base64, in order to make it readable for the AngularJS client.</p>

<p>And the last method in the proxy is <code>disconnectClient</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">disconnectClient</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">clients</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">socket</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">rfb</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">interval</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">clients</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">socket</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>


<p>As its name states it disconnects clients. This method is called with socket. First, it finds the client, which corresponds to the given socket, ends its RFB connection and removes it from the <code>clients</code> array.</p>

<p>And now we are done with the proxy! Lets continue with the fun part, AngularJS and Yeoman!</p>

<h2 id="angular-vnc">AngularJS &amp; Yeoman VNC client</h2>

<p>First, of all you will need to install Yeoman, if you don&#8217;t already have it on your computer:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="c1"># Installs Yeoman</span>
npm install -g yeoman
<span class="c1"># Installs the AngularJS generator for Yeoman</span>
npm install -g generator-angular
</code></pre></div>


<p>Now we can begin! Inside the directory <code>angular-vnc</code> create a directory called <code>client</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">cd</span> angular-vnc
mkdir client
<span class="nb">cd</span> client
<span class="c1"># Creates new AngularJS application</span>
yo angular
</code></pre></div>


<p>Yeoman will ask you few questions, you should answer as follows:</p>

<p><a href="/images/legacy/uploads2014/02/Screen-Shot-2014-02-08-at-19.29.28.png"><img class="aligncenter size-full wp-image-626" alt="Yeoman AngularJS VNC configuration" src="/images/legacy/uploads2014/02/Screen-Shot-2014-02-08-at-19.29.28.png" width="528" height="325" /></a></p>

<p>We are going to use Bootstrap and `angular-route.js`. Wait few seconds and all required dependencies will be resolved.</p>

<p>Look at: <code>app/scripts/app.js</code>, its content should be something like:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;angApp&#39;</span><span class="p">,</span> <span class="p">[</span>
  <span class="s1">&#39;ngRoute&#39;</span>
<span class="p">])</span>
  <span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$routeProvider</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$routeProvider</span>
      <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;views/main.html&#39;</span><span class="p">,</span>
        <span class="nx">controller</span><span class="o">:</span> <span class="s1">&#39;MainCtrl&#39;</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">otherwise</span><span class="p">({</span>
        <span class="nx">redirectTo</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span>
      <span class="p">});</span>
  <span class="p">});</span>
</code></pre></div>


<p>Now in the <code>client</code> directory run:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">yo</span> <span class="nx">angular</span><span class="o">:</span><span class="nx">route</span> <span class="nx">vnc</span>
</code></pre></div>


<p>After the command completes, the content of <code>app/scripts/app.js</code>, should be magically turned into:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;angApp&#39;</span><span class="p">,</span> <span class="p">[</span>
  <span class="s1">&#39;ngRoute&#39;</span>
<span class="p">])</span>
  <span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$routeProvider</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$routeProvider</span>
      <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;views/main.html&#39;</span><span class="p">,</span>
        <span class="nx">controller</span><span class="o">:</span> <span class="s1">&#39;MainCtrl&#39;</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">&#39;/vnc&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;views/vnc.html&#39;</span><span class="p">,</span>
        <span class="nx">controller</span><span class="o">:</span> <span class="s1">&#39;VncCtrl&#39;</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">otherwise</span><span class="p">({</span>
        <span class="nx">redirectTo</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span>
      <span class="p">});</span>
  <span class="p">});</span>
</code></pre></div>


<p>For next step, replace the content of <code>app/views/main.html</code> with:</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;margin-top:20px&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-xs-12 col-sm-8 col-md-6 col-sm-offset-2 col-md-offset-3&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">role</span><span class="o">=</span><span class="s">&quot;form&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;vnc-form&quot;</span> <span class="na">novalidate</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>VNC Login<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">hr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;colorgraph&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-error&quot;</span> <span class="na">ng-bind</span><span class="o">=</span><span class="s">&quot;errorMessage&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;hostname&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;hostname-input&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control input-lg&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Hostname&quot;</span> <span class="na">ng-model</span><span class="o">=</span><span class="s">&quot;host.hostname&quot;</span> <span class="na">required</span> <span class="na">ng-minlength</span><span class="o">=</span><span class="s">&quot;3&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;number&quot;</span> <span class="na">min</span><span class="o">=</span><span class="s">&quot;1&quot;</span> <span class="na">max</span><span class="o">=</span><span class="s">&quot;65535&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;port&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;port-input&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control input-lg&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Port&quot;</span> <span class="na">ng-model</span><span class="o">=</span><span class="s">&quot;host.port&quot;</span> <span class="na">required</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;password-input&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control input-lg&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Password&quot;</span> <span class="na">ng-model</span><span class="o">=</span><span class="s">&quot;host.password&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-lg btn-primary btn-block&quot;</span> <span class="na">ng-click</span><span class="o">=</span><span class="s">&quot;login()&quot;</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">hr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;colorgraph&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>


<p>You should also insert some CSS at <code>app/styles/main.css</code>:</p>

<div class="highlight"><pre><code class="language-css" data-lang="css"><span></span><span class="p">.</span><span class="nc">colorgraph</span> <span class="p">{</span>
  <span class="k">margin-bottom</span><span class="p">:</span> <span class="mi">7</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">border-top</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">background</span><span class="p">:</span> <span class="mh">#c4e17f</span><span class="p">;</span>
  <span class="k">border-radius</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">background-image</span><span class="p">:</span> <span class="bp">-webkit-</span><span class="nb">linear-gradient</span><span class="p">(</span><span class="kc">left</span><span class="p">,</span> <span class="mh">#c4e17f</span><span class="p">,</span> <span class="mh">#c4e17f</span> <span class="mf">12.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f7fdca</span> <span class="mf">12.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f7fdca</span> <span class="mi">25</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#fecf71</span> <span class="mi">25</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#fecf71</span> <span class="mf">37.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f0776c</span> <span class="mf">37.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f0776c</span> <span class="mi">50</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#db9dbe</span> <span class="mi">50</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#db9dbe</span> <span class="mf">62.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#c49cde</span> <span class="mf">62.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#c49cde</span> <span class="mi">75</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#669ae1</span> <span class="mi">75</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#669ae1</span> <span class="mf">87.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#62c2e4</span> <span class="mf">87.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#62c2e4</span><span class="p">);</span>
  <span class="k">background-image</span><span class="p">:</span> <span class="bp">-moz-</span><span class="nb">linear-gradient</span><span class="p">(</span><span class="kc">left</span><span class="p">,</span> <span class="mh">#c4e17f</span><span class="p">,</span> <span class="mh">#c4e17f</span> <span class="mf">12.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f7fdca</span> <span class="mf">12.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f7fdca</span> <span class="mi">25</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#fecf71</span> <span class="mi">25</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#fecf71</span> <span class="mf">37.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f0776c</span> <span class="mf">37.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f0776c</span> <span class="mi">50</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#db9dbe</span> <span class="mi">50</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#db9dbe</span> <span class="mf">62.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#c49cde</span> <span class="mf">62.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#c49cde</span> <span class="mi">75</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#669ae1</span> <span class="mi">75</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#669ae1</span> <span class="mf">87.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#62c2e4</span> <span class="mf">87.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#62c2e4</span><span class="p">);</span>
  <span class="k">background-image</span><span class="p">:</span> <span class="bp">-o-</span><span class="nb">linear-gradient</span><span class="p">(</span><span class="kc">left</span><span class="p">,</span> <span class="mh">#c4e17f</span><span class="p">,</span> <span class="mh">#c4e17f</span> <span class="mf">12.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f7fdca</span> <span class="mf">12.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f7fdca</span> <span class="mi">25</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#fecf71</span> <span class="mi">25</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#fecf71</span> <span class="mf">37.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f0776c</span> <span class="mf">37.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f0776c</span> <span class="mi">50</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#db9dbe</span> <span class="mi">50</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#db9dbe</span> <span class="mf">62.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#c49cde</span> <span class="mf">62.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#c49cde</span> <span class="mi">75</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#669ae1</span> <span class="mi">75</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#669ae1</span> <span class="mf">87.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#62c2e4</span> <span class="mf">87.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#62c2e4</span><span class="p">);</span>
  <span class="k">background-image</span><span class="p">:</span> <span class="nb">linear-gradient</span><span class="p">(</span><span class="kc">to</span> <span class="kc">right</span><span class="p">,</span> <span class="mh">#c4e17f</span><span class="p">,</span> <span class="mh">#c4e17f</span> <span class="mf">12.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f7fdca</span> <span class="mf">12.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f7fdca</span> <span class="mi">25</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#fecf71</span> <span class="mi">25</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#fecf71</span> <span class="mf">37.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f0776c</span> <span class="mf">37.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#f0776c</span> <span class="mi">50</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#db9dbe</span> <span class="mi">50</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#db9dbe</span> <span class="mf">62.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#c49cde</span> <span class="mf">62.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#c49cde</span> <span class="mi">75</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#669ae1</span> <span class="mi">75</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#669ae1</span> <span class="mf">87.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#62c2e4</span> <span class="mf">87.5</span><span class="kt">%</span><span class="p">,</span> <span class="mh">#62c2e4</span><span class="p">);</span>
<span class="p">}</span>

<span class="nt">form</span><span class="p">.</span><span class="nc">ng-invalid</span><span class="p">.</span><span class="nc">ng-dirty</span> <span class="nt">input</span><span class="p">.</span><span class="nc">ng-invalid</span> <span class="p">{</span>
  <span class="k">border-color</span><span class="p">:</span> <span class="mh">#ff0000</span> <span class="cp">!important</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">form-error</span> <span class="p">{</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">25</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">color</span><span class="p">:</span> <span class="kc">red</span><span class="p">;</span>
  <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>This defines the markup and styles for simple Bootstrap form.</p>

<p>After you start the proxy:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">cd</span> ../proxy
node index.js
</code></pre></div>


<p>and open <a href="http://localhost:8090">http://localhost:8090</a>, you should see something like this:</p>

<p><a href="/images/legacy/uploads2014/02/Screen-Shot-2014-02-08-at-20.43.44.png"><img class="aligncenter size-full wp-image-641" alt="VNC Login Form" src="/images/legacy/uploads2014/02/Screen-Shot-2014-02-08-at-20.43.44.png" width="374" height="369" /></a></p>

<p>The awesome thing is that we already have validation for the form! Did you notice that we added selector <code>form.ng-invalid.ng-dirty input.ng-invalid</code>? AngularJS is smart enough to validate the fields in our form by seeing their type (for example <code>input type=&quot;number&quot;</code>, for the port) and their attributes (<code>required</code>, <code>ng-minlength</code>). When AngularJS detects that any field is not valid it adds the class: <code>ng-invalid</code> to the field, it also adds the class <code>ng-invalid</code> to the form, where this field is located. We, simply, take advantage, of this functionality provided by AngularJS, and define the styles: <code>form.ng-invalid.ng-dirty input.ng-invalid</code>. If you&#8217;re still not aware how the validation works checkout <a href="http://ng-tutorial.mgechev.com/#?tutorial=form-validation&amp;step=basic-validation">Form Validation in NG-Tutorial</a>.</p>

<p>We already have attached controller, to our view (because of Yeoman), so we only need to change its behavior.</p>

<p>Replace the content of <code>app/scripts/controllers/main.js</code> with the following snippet:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;clientApp&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;MainCtrl&#39;</span><span class="p">,</span>
  <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">VNCClient</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">proxyUrl</span> <span class="o">=</span> <span class="nx">$location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="nx">$location</span><span class="p">.</span><span class="nx">host</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">$location</span><span class="p">.</span><span class="nx">port</span><span class="p">();</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nx">$scope</span><span class="p">[</span><span class="s1">&#39;vnc-form&#39;</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">$invalid</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">form</span><span class="p">.</span><span class="nx">$setDirty</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">VNCClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">&#39;/vnc&#39;</span><span class="p">)</span>
        <span class="p">},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">errorMessage</span> <span class="o">=</span> <span class="s1">&#39;Connection timeout. Please, try again.&#39;</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">};</span>

  <span class="p">});</span>
</code></pre></div>


<p>The most interesting part of <code>MainCtrl</code> is the <code>login</code> method. In it, we first check wether the form is invalid (<code>form.$invalid</code>), if it is we make the it &#8220;dirty&#8221;. We do this in order to remove the <code>ng-pristine</code> class from the form and force the validation. This scenario will happen if the user does not enter anything in the form and press the &#8220;Login&#8221; button. If the form is valid, we call the <code>connect</code> method of the service <code>VNCClient</code>. As you see it returns promise, when the promise is resolved we redirect the user to the page <a href="http://localhost:8090/#/vnc">http://localhost:8090/#/vnc</a>, otherwise we show him or her the message: <code>'Connection timeout. Please, try again.'</code> (checkout <code>&lt;div class=&quot;form-error&quot; ng-bind=&quot;errorMessage&quot;&gt;&lt;/div&gt;</code>).</p>

<p>The next component we are going to look at is the service <code>VNCClient</code>. Before that, lets create it using Yeoman:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>yo angular:service VNCClient
</code></pre></div>


<p>Now open the file: <code>app/scripts/services/vncclient.js</code> and place the following content there:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">CONNECTION_TIMEOUT</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">VNCClient</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">Io</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">frameCallbacks</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">addFrameCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">frameCallbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">frameCallbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">frame</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">removeFrameCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cbs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">frameCallbacks</span><span class="p">;</span>
    <span class="nx">cbs</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">cbs</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">fn</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">sendMouseEvent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">mask</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span>
      <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span><span class="p">,</span>
      <span class="nx">button</span><span class="o">:</span> <span class="nx">mask</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">sendKeyboardEvent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">shift</span><span class="p">,</span> <span class="nx">isDown</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rfbKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toRfbKeyCode</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">shift</span><span class="p">,</span> <span class="nx">isDown</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">rfbKey</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;keyboard&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">keyCode</span><span class="o">:</span> <span class="nx">rfbKey</span><span class="p">,</span>
        <span class="nx">isDown</span><span class="o">:</span> <span class="nx">isDown</span>
      <span class="p">});</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">(),</span>
        <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">forceNewConnection</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">Io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">proxyUrl</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">Io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">proxyUrl</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;force new connection&#39;</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">hostname</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
      <span class="nx">port</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">addHandlers</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setConnectionTimeout</span><span class="p">(</span><span class="nx">deferred</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">screenWidth</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">screenHeight</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">connectionTimeout</span><span class="p">);</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">disconnect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setConnectionTimeout</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">deferred</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">connectionTimeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
    <span class="p">},</span> <span class="nx">CONNECTION_TIMEOUT</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">addHandlers</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">toRfbKeyCode</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">shift</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keyMap</span> <span class="o">=</span> <span class="nx">VNCClient</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">keyMap</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">==</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">shift</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">};</span>

<span class="p">}</span>

<span class="nx">VNCClient</span><span class="p">.</span><span class="nx">keyMap</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">8</span><span class="p">,</span><span class="mi">65288</span><span class="p">,</span><span class="mi">65288</span><span class="p">],[</span><span class="mi">9</span><span class="p">,</span><span class="mi">65289</span><span class="p">,</span><span class="mi">65289</span><span class="p">],[</span><span class="mi">13</span><span class="p">,</span><span class="mi">65293</span><span class="p">,</span><span class="mi">65293</span><span class="p">],[</span><span class="mi">16</span><span class="p">,</span><span class="mi">65505</span><span class="p">,</span><span class="mi">65505</span><span class="p">],[</span><span class="mi">16</span><span class="p">,</span><span class="mi">65506</span><span class="p">,</span><span class="mi">65506</span><span class="p">],[</span><span class="mi">17</span><span class="p">,</span><span class="mi">65507</span><span class="p">,</span><span class="mi">65507</span><span class="p">],[</span><span class="mi">17</span><span class="p">,</span><span class="mi">65508</span><span class="p">,</span><span class="mi">65508</span><span class="p">],[</span><span class="mi">18</span><span class="p">,</span><span class="mi">65513</span><span class="p">,</span><span class="mi">65513</span><span class="p">],[</span><span class="mi">18</span><span class="p">,</span><span class="mi">65514</span><span class="p">,</span><span class="mi">65514</span><span class="p">],[</span><span class="mi">27</span><span class="p">,</span><span class="mi">65307</span><span class="p">,</span><span class="mi">65307</span><span class="p">],[</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">],[</span><span class="mi">33</span><span class="p">,</span><span class="mi">65365</span><span class="p">,</span><span class="mi">65365</span><span class="p">],[</span><span class="mi">34</span><span class="p">,</span><span class="mi">65366</span><span class="p">,</span><span class="mi">65366</span><span class="p">],[</span><span class="mi">35</span><span class="p">,</span><span class="mi">65367</span><span class="p">,</span><span class="mi">65367</span><span class="p">],[</span><span class="mi">36</span><span class="p">,</span><span class="mi">65360</span><span class="p">,</span><span class="mi">65360</span><span class="p">],[</span><span class="mi">37</span><span class="p">,</span><span class="mi">65361</span><span class="p">,</span><span class="mi">65361</span><span class="p">],[</span><span class="mi">38</span><span class="p">,</span><span class="mi">65362</span><span class="p">,</span><span class="mi">65362</span><span class="p">],[</span><span class="mi">39</span><span class="p">,</span><span class="mi">65363</span><span class="p">,</span><span class="mi">65363</span><span class="p">],[</span><span class="mi">40</span><span class="p">,</span><span class="mi">65364</span><span class="p">,</span><span class="mi">65364</span><span class="p">],[</span><span class="mi">45</span><span class="p">,</span><span class="mi">65379</span><span class="p">,</span><span class="mi">65379</span><span class="p">],[</span><span class="mi">46</span><span class="p">,</span><span class="mi">65535</span><span class="p">,</span><span class="mi">65535</span><span class="p">],[</span><span class="mi">48</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">41</span><span class="p">],[</span><span class="mi">49</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">33</span><span class="p">],[</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">64</span><span class="p">],[</span><span class="mi">51</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">35</span><span class="p">],[</span><span class="mi">52</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">36</span><span class="p">],[</span><span class="mi">53</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">37</span><span class="p">],[</span><span class="mi">54</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">94</span><span class="p">],[</span><span class="mi">55</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">38</span><span class="p">],[</span><span class="mi">56</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">42</span><span class="p">],[</span><span class="mi">57</span><span class="p">,</span><span class="mi">57</span><span class="p">,</span><span class="mi">40</span><span class="p">],[</span><span class="mi">65</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">65</span><span class="p">],[</span><span class="mi">66</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">66</span><span class="p">],[</span><span class="mi">67</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">67</span><span class="p">],[</span><span class="mi">68</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">68</span><span class="p">],[</span><span class="mi">69</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">69</span><span class="p">],[</span><span class="mi">70</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">70</span><span class="p">],[</span><span class="mi">71</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">71</span><span class="p">],[</span><span class="mi">72</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">72</span><span class="p">],[</span><span class="mi">73</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">73</span><span class="p">],[</span><span class="mi">74</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">74</span><span class="p">],[</span><span class="mi">75</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">75</span><span class="p">],[</span><span class="mi">76</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">76</span><span class="p">],[</span><span class="mi">77</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">77</span><span class="p">],[</span><span class="mi">78</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">78</span><span class="p">],[</span><span class="mi">79</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">79</span><span class="p">],[</span><span class="mi">80</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">80</span><span class="p">],[</span><span class="mi">81</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">81</span><span class="p">],[</span><span class="mi">82</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">82</span><span class="p">],[</span><span class="mi">83</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">83</span><span class="p">],[</span><span class="mi">84</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">84</span><span class="p">],[</span><span class="mi">85</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">85</span><span class="p">],[</span><span class="mi">86</span><span class="p">,</span><span class="mi">118</span><span class="p">,</span><span class="mi">86</span><span class="p">],[</span><span class="mi">87</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">87</span><span class="p">],[</span><span class="mi">88</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">88</span><span class="p">],[</span><span class="mi">89</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">89</span><span class="p">],[</span><span class="mi">90</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mi">90</span><span class="p">],[</span><span class="mi">97</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">49</span><span class="p">],[</span><span class="mi">98</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">],[</span><span class="mi">99</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">51</span><span class="p">],[</span><span class="mi">100</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">52</span><span class="p">],[</span><span class="mi">101</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">53</span><span class="p">],[</span><span class="mi">102</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">54</span><span class="p">],[</span><span class="mi">103</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">55</span><span class="p">],[</span><span class="mi">104</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">56</span><span class="p">],[</span><span class="mi">105</span><span class="p">,</span><span class="mi">57</span><span class="p">,</span><span class="mi">57</span><span class="p">],[</span><span class="mi">106</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">42</span><span class="p">],[</span><span class="mi">107</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">61</span><span class="p">],[</span><span class="mi">109</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">45</span><span class="p">],[</span><span class="mi">110</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">46</span><span class="p">],[</span><span class="mi">111</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">47</span><span class="p">],[</span><span class="mi">112</span><span class="p">,</span><span class="mi">65470</span><span class="p">,</span><span class="mi">65470</span><span class="p">],[</span><span class="mi">113</span><span class="p">,</span><span class="mi">65471</span><span class="p">,</span><span class="mi">65471</span><span class="p">],[</span><span class="mi">114</span><span class="p">,</span><span class="mi">65472</span><span class="p">,</span><span class="mi">65472</span><span class="p">],[</span><span class="mi">115</span><span class="p">,</span><span class="mi">65473</span><span class="p">,</span><span class="mi">65473</span><span class="p">],[</span><span class="mi">116</span><span class="p">,</span><span class="mi">65474</span><span class="p">,</span><span class="mi">65474</span><span class="p">],[</span><span class="mi">117</span><span class="p">,</span><span class="mi">65475</span><span class="p">,</span><span class="mi">65475</span><span class="p">],[</span><span class="mi">118</span><span class="p">,</span><span class="mi">65476</span><span class="p">,</span><span class="mi">65476</span><span class="p">],[</span><span class="mi">119</span><span class="p">,</span><span class="mi">65477</span><span class="p">,</span><span class="mi">65477</span><span class="p">],[</span><span class="mi">120</span><span class="p">,</span><span class="mi">65478</span><span class="p">,</span><span class="mi">65478</span><span class="p">],[</span><span class="mi">121</span><span class="p">,</span><span class="mi">65479</span><span class="p">,</span><span class="mi">65479</span><span class="p">],[</span><span class="mi">122</span><span class="p">,</span><span class="mi">65480</span><span class="p">,</span><span class="mi">65480</span><span class="p">],[</span><span class="mi">123</span><span class="p">,</span><span class="mi">65481</span><span class="p">,</span><span class="mi">65481</span><span class="p">],[</span><span class="mi">186</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">58</span><span class="p">],[</span><span class="mi">187</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">43</span><span class="p">],[</span><span class="mi">188</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">60</span><span class="p">],[</span><span class="mi">189</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">95</span><span class="p">],[</span><span class="mi">190</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">62</span><span class="p">],[</span><span class="mi">191</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">63</span><span class="p">],[</span><span class="mi">192</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">126</span><span class="p">],[</span><span class="mi">220</span><span class="p">,</span><span class="mi">92</span><span class="p">,</span><span class="mi">124</span><span class="p">],[</span><span class="mi">221</span><span class="p">,</span><span class="mi">93</span><span class="p">,</span><span class="mi">125</span><span class="p">],[</span><span class="mi">222</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">34</span><span class="p">],[</span><span class="mi">219</span><span class="p">,</span><span class="mi">91</span><span class="p">,</span><span class="mi">123</span><span class="p">]];</span>

<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;clientApp&#39;</span><span class="p">).</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;VNCClient&#39;</span><span class="p">,</span> <span class="nx">VNCClient</span><span class="p">);</span>
</code></pre></div>


<p>I know it is a lot of code but we will look only at the most important methods. You might noticed that we don&#8217;t follow the best practices for defining constructor functions &#8211; we don&#8217;t add the methods to the function&#8217;s prototype. Don&#8217;t worry about this, AngularJS will create a single instance of this constructor function and keep it in the services cache.</p>

<p>Lets take a quick look at <code>connect</code>:</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="k">this</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">(),</span>
        <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">forceNewConnection</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">Io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">proxyUrl</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">Io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">proxyUrl</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;force new connection&#39;</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">hostname</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span>
      <span class="nx">port</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">addHandlers</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setConnectionTimeout</span><span class="p">(</span><span class="nx">deferred</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">screenWidth</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">screenHeight</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">connectionTimeout</span><span class="p">);</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
  <span class="p">};</span>
</code></pre></div>
</p>

<p><code>connect</code> accepts a single argument &#8211; a configuration object. When the method is called it creates new socket using the service <code>Io</code>, which is simple wrapper of the global <code>io</code> provided by socket.io. We need this wrapper in order to be able to test the application easier and prevent monkey patching. After the socket is created we send new <code>init</code> message to the proxy (do you remember the init message?), with the required configuration for connecting to the VNC server. We also create a connection timeout. The connection timeout is quite important, if we receive a late response by the proxy or don&#8217;t receive any response at all. The next important part of the <code>connect</code> method is the handler of the response <code>init</code> message, by the proxy. When we receive the response within the acceptable time limit (remember the timeout) we resolve the promise, which was instantiated earlier in the beginning of the <code>connect</code> method.</p>

<p>This way we transform a callback interface (by socket.io) into a promise based interface.</p>

<p>This is the implementation of the <code>addHandlers</code> method:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="k">this</span><span class="p">.</span><span class="nx">addHandlers</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>
</code></pre></div>


<p>Actually we add a single handler, which handles the <code>frame</code> events, which carries new (changed) screen fragments. When new frame is received we invoke the <code>update</code> method. It may look familiar to you &#8211; this is actually the <a href="https://en.wikipedia.org/wiki/Observer_pattern">observer pattern</a>. We add/remove callbacks using the following methods:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="k">this</span><span class="p">.</span><span class="nx">addFrameCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">frameCallbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">removeFrameCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cbs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">frameCallbacks</span><span class="p">;</span>
    <span class="nx">cbs</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">cbs</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">fn</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">};</span>
</code></pre></div>


<p>And in <code>update</code> we simply:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="k">this</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">frameCallbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">frame</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>
</code></pre></div>


<p>Since we need to capture events in the browsers (like pressing keys, mouse events&#8230;) and send them to the server we need methods for this:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="k">this</span><span class="p">.</span><span class="nx">sendMouseEvent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">mask</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span>
      <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span><span class="p">,</span>
      <span class="nx">button</span><span class="o">:</span> <span class="nx">mask</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">sendKeyboardEvent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">shift</span><span class="p">,</span> <span class="nx">isDown</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rfbKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toRfbKeyCode</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">shift</span><span class="p">,</span> <span class="nx">isDown</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">rfbKey</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;keyboard&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">keyCode</span><span class="o">:</span> <span class="nx">rfbKey</span><span class="p">,</span>
        <span class="nx">isDown</span><span class="o">:</span> <span class="nx">isDown</span>
      <span class="p">});</span>
  <span class="p">};</span>
</code></pre></div>


<p>The <a href="https://github.com/mgechev/angular-vnc/blob/master/client/app/scripts/directives/vnc-screen.js">VNC screen</a> directive is responsible for calling these methods. In the <code>sendKeyboardEvent</code> we transform the <code>keyCode</code>, received by handling the keydown/up event with JavaScript, to one, which is understandable by the RFB protocol. We do this using the array <code>keyMap</code> defined above.</p>

<p>Since we didn&#8217;t create the <code>Io</code> service, you can instantiate it by:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>yo angular:factory Io
</code></pre></div>


<p>And place the following snippet inside <code>app/scripts/services/io.js</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;clientApp&#39;</span><span class="p">).</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;Io&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">connect</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">});</span>
</code></pre></div>


<p>Don&#8217;t forget to include the line:</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>


<p>in <code>app/index.html</code>.</p>

<p>And now, the last component is the VNC screen directive! But before looking at it, replace the content of <code>app/views/vnc.html</code> with the following markup:</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;screen-wrapper&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">vnc-screen</span><span class="p">&gt;&lt;/</span><span class="nt">vnc-screen</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-danger&quot;</span> <span class="na">ng-show</span><span class="o">=</span><span class="s">&quot;connected()&quot;</span> <span class="na">ng-click</span><span class="o">=</span><span class="s">&quot;disconnect()&quot;</span><span class="p">&gt;</span>Disconnect<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#/&quot;</span> <span class="na">ng-hide</span><span class="o">=</span><span class="s">&quot;connected()&quot;</span><span class="p">&gt;</span>Back<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>


<p>as you see we include our VNC screen completely declaratively: <code>&lt;vnc-screen&gt;&lt;/vnc-screen&gt;</code>. In the markup above, we have few directives: <code>ng-show=&quot;connected()&quot;, ng-click=&quot;disconnect()&quot;, ng-hide=&quot;connected()&quot;</code>, they has expressions referring to methods attached to the scope in the <code>VncCtrl</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;clientApp&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;VncCtrl&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">VNCClient</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">disconnect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">VNCClient</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">connected</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">VNCClient</span><span class="p">.</span><span class="nx">connected</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">});</span>
</code></pre></div>


<p><code>VncCtrl</code> is already located in <code>app/scripts/controllers/vnc.js</code>. You don&#8217;t have to worry about it because when we instantiated the <code>vnc</code> route, Yeoman was smart enough to create this controller for us.</p>

<p>Now lets create the VNC screen directive:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>yo angular:directive vnc-screen
</code></pre></div>


<p>&#8230;and now open <code>app/scripts/directives/vnc-screen.js</code>. This is our directive definition:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">var</span> <span class="nx">VNCScreenDirective</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">VNCClient</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;canvas class=&quot;vnc-screen&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">,</span>
    <span class="nx">replace</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">restrict</span><span class="o">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
    <span class="nx">link</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">postLink</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//body...</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">};</span>
<span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;clientApp&#39;</span><span class="p">).</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;vncScreen&#39;</span><span class="p">,</span> <span class="nx">VNCScreenDirective</span><span class="p">);</span>
</code></pre></div>


<p>The show is in the link function in, which we will look at later. Now lets take a quick look at the other properties of the directive. The template of our directive is simple canvas with class <code>vnc-screen</code>, it should replace the directive. We define that the user of the <code>vnc-screen</code> directive should use it as element. It is also quite important to notice that we have a single dependency &#8211; the <code>VNCClient</code> service, we described above.</p>

<p>Now lets look what happens in the link function:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">VNCClient</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="s1">&#39;&lt;span&gt;No VNC connection.&lt;/span&gt;&#39;</span><span class="p">).</span><span class="nx">insertAfter</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">frameCallback</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">screen</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nx">drawRect</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
    <span class="nx">screen</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createHiddenCanvas</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;absolute&#39;</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="o">-</span><span class="nx">height</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="o">-</span><span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span><span class="p">;</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">canvas</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">bufferCanvas</span> <span class="o">=</span> <span class="nx">createHiddenCanvas</span><span class="p">(</span><span class="nx">VNCClient</span><span class="p">.</span><span class="nx">screenWidth</span><span class="p">,</span> <span class="nx">VNCClient</span><span class="p">.</span><span class="nx">screenHeight</span><span class="p">),</span>
    <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VNCClientScreen</span><span class="p">(</span><span class="nx">bufferCanvas</span><span class="p">),</span>
    <span class="nx">screen</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Screen</span><span class="p">(</span><span class="nx">element</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">buffer</span><span class="p">),</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">frameCallback</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">screen</span><span class="p">);</span>

<span class="nx">VNCClient</span><span class="p">.</span><span class="nx">addFrameCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="nx">screen</span><span class="p">.</span><span class="nx">addKeyboardHandlers</span><span class="p">(</span><span class="nx">VNCClient</span><span class="p">.</span><span class="nx">sendKeyboardEvent</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">VNCClient</span><span class="p">));</span>
<span class="nx">screen</span><span class="p">.</span><span class="nx">addMouseHandler</span><span class="p">(</span><span class="nx">VNCClient</span><span class="p">.</span><span class="nx">sendMouseEvent</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">VNCClient</span><span class="p">));</span>

<span class="nx">scope</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="s1">&#39;$destroy&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">VNCClient</span><span class="p">.</span><span class="nx">removeFrameCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
  <span class="nx">bufferCanvas</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>


<p>As first step the link function checks whether the <code>VNCClient</code> is connected, if it isn&#8217;t the directive simply adds the text <code>&quot;No VNC connection.&quot;</code> and hides the template (actually now a DOM element). We can also take more advanced approach here, we can watch the <code>connected</code> property and undertake different actions depending on its value. Doing this will make our directive more dynamic. But for simplicity lets stick to the current implementation.</p>

<p>The line <code>var bufferCanvas = createHiddenCanvas(VNCClient.screenWidth, VNCClient.screenHeight)</code> creates new hidden canvas. It is responsible for capturing the current state of the remote screen in size the same as the screen itself. So if the size of the remote screen is 1024x768px this hidden canvas will be with 1024px width and 768px height. We instantiate new instance of <code>VNCClientScreen</code> with parameter the hidden canvas. The constructor function <code>VNCClientScreen</code> wraps the canvas and provides method for drawing on it:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">VNCClientScreen</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">onUpdateCbs</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="nx">VNCClientScreen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawRect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">(),</span>
      <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">img</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
  <span class="nx">img</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
  <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;data:image/png;base64,&#39;</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">image</span><span class="p">;</span>
  <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">onUpdateCbs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cb</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">VNCClientScreen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getCanvas</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>As next step we create new instance of <code>Screen</code>. This is the last component we are going to look at in the current tutorial but before taking a look at it lets see how we use it.</p>

<p>We instantiate the <code>Screen</code> instance by passing our &#8220;visible&#8221; canvas and the VNC screen buffer (the wrapper of the &#8220;hidden&#8221; canvas) to it. For each received frame we are going to draw the buffer canvas over the VNC screen. We do this because the VNC screen could be scaled (i.e. with size different from the one of the remote machine&#8217;s screen) and we simplify our work by using this approach. Otherwise, we should calculate the relative position of each received frame before drawing it onto the canvas, taking in account the scale factor.</p>

<p>In the <code>frameCallback</code> we draw the received rectangle (changed part of the screen) on the buffer screen and after that draw the buffer screen over the <code>Screen</code> instance.</p>

<p>In the link function we also invoke the methods:</p>

<ul>
<li><code>addKeyboardHandlers</code></li>
<li><code>addMouseHandler</code></li>
</ul>

<p>They simply delegate handling of mouse and keyboard event to the <code>VNCClient</code>. Here is the implementation of the <code>addKeyboardHandlers</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addKeyboardHandlers</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyDownHandler</span><span class="p">(</span><span class="nx">cb</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyUpHandler</span><span class="p">(</span><span class="nx">cb</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">keyUpHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyUpHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">keyDownHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyDownHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>


<p>Now you also see why we used <code>VNCClient.sendKeyboardEvent.bind(VNCClient)</code>, because in <code>keyDownHandler</code> and <code>keyUpHandler</code> we invoke the callback with context <code>null</code>. By using <code>bind</code> we force the context to be the <code>VNCClient</code> itself.</p>

<p>And we are done! We skipped some of the methods of <code>Screen</code> because I think their consideration is not that essential for the purpose of this tutorial. Anyway, here is the whole implementation of the <code>Screen</code> constructor function:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">Screen</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bufferCanvas</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">getCanvas</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">originalWidth</span> <span class="o">=</span> <span class="nx">bufferCanvas</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">originalHeight</span> <span class="o">=</span> <span class="nx">bufferCanvas</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">resize</span><span class="p">(</span><span class="nx">bufferCanvas</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">resize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">getCanvas</span><span class="p">(),</span>
      <span class="nx">ratio</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
      <span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span>
      <span class="nx">width</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span>
      <span class="nx">height</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">/</span> <span class="nx">ratio</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">&gt;</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">*</span> <span class="nx">ratio</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addMouseHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">buttonsState</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
      <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">getMask</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">copy</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">buttonsState</span><span class="p">),</span>
        <span class="nx">buttons</span> <span class="o">=</span> <span class="nx">copy</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">buttons</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getMousePosition</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span>
        <span class="nx">oc</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">getCanvas</span><span class="p">(),</span>
        <span class="nx">pos</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">(),</span>
        <span class="nx">width</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
        <span class="nx">oWidth</span> <span class="o">=</span> <span class="nx">oc</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
        <span class="nx">oHeight</span> <span class="o">=</span> <span class="nx">oc</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
        <span class="nx">widthRatio</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">/</span> <span class="nx">oWidth</span><span class="p">,</span>
        <span class="nx">heightRatio</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">/</span> <span class="nx">oHeight</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">x</span><span class="o">:</span> <span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span> <span class="o">/</span> <span class="nx">widthRatio</span><span class="p">,</span>
      <span class="nx">y</span><span class="o">:</span> <span class="p">(</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">/</span> <span class="nx">heightRatio</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">buttonsState</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">getMousePosition</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">);</span>
      <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">getMask</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">buttonsState</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">getMousePosition</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">);</span>
      <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">getMask</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;contextmenu&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">getMousePosition</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">);</span>
    <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">getMask</span><span class="p">());</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addKeyboardHandlers</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyDownHandler</span><span class="p">(</span><span class="nx">cb</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyUpHandler</span><span class="p">(</span><span class="nx">cb</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">keyUpHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyUpHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">keyDownHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyDownHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">redraw</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">getCanvas</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyDownHandler</span><span class="p">);</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyUpHandler</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;contextmenu&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;mousemove&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;mousedown&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;mouseup&#39;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>


<p>The last step is to run the VNC client! Make sure you have a computer with VNC server on it.</p>

<p>Run the following command:</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">cd</span> angular-vnc
<span class="nb">cd</span> proxy
node index.js
</code></pre></div>
</p>

<p>Now open the url: <a href="http://localhost:8090">http://localhost:8090</a>, and rock!</p>

<h2 id="vnc-demo-video">Demo</h2>

<iframe width="420" height="315" src="//www.youtube.com/embed/FwPjTt4dQmw" frameborder="0" allowfullscreen></iframe>

                </section>
            </article>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'mgechev';

     
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            

            

            <footer id="footer">
    <div class="by-author">with <i class="fa fa-heart" aria-hidden="true"></i> by Minko Gechev</div>
    <p class="small">
         © Copyright 2017  
    </p>
</footer>
        </section>

        <script src="http://blog.mgechev.com/js/main.js"></script>




  
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-18060688-3', 'auto');
ga('send', 'pageview');
</script>





    </body>
</html>
